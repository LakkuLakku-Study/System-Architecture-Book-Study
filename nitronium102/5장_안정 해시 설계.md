# 05. 안정 해시 설계

## 📒 해시 키 재배치rehash 문제
일반적으로 아래와 같은 함수 사용 <br>
`serverIdx = hashkey % (서버의 개수)`

### 특징
- 서버 풀의 크기가 고정되어 있거나 데이터 분포가 균등할 때는 잘 동작
- 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다

#### 예시 
- 1번 서버가 장애를 일으켜 동작을 중단하면 서버 풀의 크기가 변화
- 키에 대한 해시값hashkey은 변하지 않지만 modular 연산을 적용하여 계산한 serverIdx 값은 달라짐

&nbsp;
- 1번 서버에 대한 키 뿐만 아니라 대부분의 키가 재분배
- 대부분의 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속
- 대규모 캐시 미스 발생

## 📒 안정 해시
해시 테이블 크기가 조정될 때 평균적으로 오직 `k/n`개의 키만 재배치하는 해시 기술
- k: 키의 개수
- n: 슬롯의 개수

### 해시 공간과 해시 링
[가정]
- 해시함수 f: SHA-1
- 함수 출력 값 범위: x0 ~ xn

&nbsp;

- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 **시계** 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버
- 서버를 추가/삭제하더라도 키 가운데 일부만 재배치
- 나머지 키에는 영향이 없음

### 기본 구현법의 두 가지 문제
1) 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는 것이 불가능하다
(파티션: 인접한 서버 사이의 해시 공간)

2) 키의 균등 분포를 달성하기가 어렵다

## 📒 가상 노드 / 복제
> 기존 구현법의 문제를 해결하기 위해 제안됨
- 가상 노드: 실제 노드 또는 서버를 가리키는 노드
    - 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다
    - 각 서버는 하나가 아닌 여러 개의 파티션을 관리해야 한다

- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다
    - 표준 편차가 작아져 데이터가 고르게 분포
- 가상 노드 데이터를 저장할 공간은 더 많이 필요하게 된다
- 따라서 시스템 요구사항에 맞도록 가상 노드 개수를 적절히 조절

### 재배치할 키 결정
서버가 추가되거나 제거되면 데이터 일부를 재배치해야 한다
- 서버가 추가되는 경우, 새로 추가된 노드로부터 **반시계 방향**에 있는 **첫 번째** 서버까지만 영향을 받는다

## 📒 마무리
#### 안정 해시의 이점
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다
- hotspot 키 문제를 줄인다
    - 특정 샤드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생기게 된다
    - 안정 해시는 데이터를 좀 더 균등하게 분배하기 때문에 해당 문제가 생길 가능성을 줄인다

#### 안정 해시 사용 예시
- Amazon DynamoDB - 파티셔닝 관련 컴포넌트
- Apache Cassandra 클러스터 - 데이터 파티셔닝
- Discord
- Akamai CDN
- Meglev 네트워크 부하 분산